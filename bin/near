#!/usr/bin/env node

const yargs = require('yargs');
const main = require('../');

const exitOnError = async function(promise) {
  try {
    await promise;
  } catch (e) {
    console.log("Error: ", e);
    process.exit(1);
  }
}

const deploy = {
  command: 'deploy',
  desc: 'deploy your smart contract',
  builder: (yargs) => yargs
    .option('wasmFile', {
      desc: 'Path to wasm file to deploy',
      type: 'string',
      default: './out/main.wasm'
    })
    .alias({
      'accountId': ['account_id', 'contractName', 'contract_name'],
    }),
  handler: (argv) => exitOnError(main.deploy(argv))
};

const scheduleFunctionCall = {
  command: 'call <contractName> <methodName> [args]',
  desc: 'schedule smart contract call which can modify state',
  builder: (yargs) => yargs
    .option('amount', {
      desc: 'Number of tokens to attach',
      type: 'string',
      default: '1000000000'
    }),
  handler: (argv) => exitOnError(main.scheduleFunctionCall(argv))
};

const callViewFunction = {
  command: 'view <contractName> <methodName> [args]',
  desc: 'make smart contract call which can view state',
  builder: (yargs) => yargs,
  handler: (argv) => exitOnError(main.callViewFunction(argv))
};

const { spawn } = require('child_process');
const build = {
  command: 'build',
  desc: 'build your smart contract',
  handler: (argv) => {
    const gulp = spawn('gulp');
    gulp.stdout.on('data', function (data) {
      console.log(data.toString());
    });
    gulp.stderr.on('data', function (data) {
      console.log(data.toString());
    });
    gulp.on('exit', function (code) {
      process.exit(code);
    });
  }
};

const createAccount = {
  command: 'create_account <accountId>',
  desc: 'create a developer account',
  builder: (yargs) => yargs
    .option('accountId', {
      desc: 'Unique identifier for the newly created account',
      type: 'string',
      required: true
    }),
  handler: (argv) => exitOnError(main.createDevAccount(argv))
};

const clean = {
  command: 'clean',
  desc: 'clean the build environment',
  builder: (yargs) => yargs
    .option('outDir', {
      desc: 'build directory',
      type: 'string',
      default: './out'
    }),
  handler: (argv) => exitOnError(main.clean(argv))
};

const newProject = {
  command: 'new_project [projectDir]',
  desc: 'create a new blank project',
  builder: (yargs) => yargs
    .option('projectDir', {
      desc: 'project directory',
      type: 'string',
      default: '.'
    }),
  handler: (argv) => exitOnError(main.newProject(argv))
};

let config = require('../get-config')();
yargs // eslint-disable-line
  .option('nodeUrl', {
    desc: 'NEAR node URL',
    type: 'string',
    default: 'http://localhost:3030'
  })
  .option('networkId', {
    desc: 'NEAR network ID, allows using different keys based on network',
    type: 'string',
    default: 'default'
  })
  .option('helperUrl', {
    desc: 'NEAR contract helper URL',
    type: 'string',
  })
  .option('useDevAccount', {
    desc: 'Forces use of special "developer" account (only works on local node)',
    type: 'boolean',
  })
  .option('accountId', {
    desc: 'Unique identifier for the account',
    type: 'string',
  })
  .command(createAccount)
  .command(build)
  .command(deploy)
  .command(scheduleFunctionCall)
  .command(callViewFunction)
  .command(clean)
  .command(newProject)
  .config(config)
  .alias({
    'accountId': ['account_id'],
    'nodeUrl': 'node_url',
    'networkId': ['network_id'],
    'wasmFile': 'wasm_file',
    'projectDir': 'project_dir',
    'outDir': 'out_dir'
  })
  .showHelpOnFail(true)
  .demandCommand(1, 'Please enter a command')
  .argv;

